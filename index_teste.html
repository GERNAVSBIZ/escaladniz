<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escala DNIZ</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

const firebaseConfig = {
  apiKey: "AIzaSyApoDIAXZ5_6GlytJp6IyesM-6epXDqo6k",
  authDomain: "dashboard-escala.firebaseapp.com",
  projectId: "dashboard-escala",
  storageBucket: "dashboard-escala.appspot.com",
  messagingSenderId: "451393122794",
  appId: "1:451393122794:web:24f125f11ef3260b770293"
};

firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_NAMES = ["Wilkson", "Adriano"];

const useAuthUser = () => {

  const [user, setUser] = React.useState(null);
  const [userData, setUserData] = React.useState(null);
  const [loading, setLoading] = React.useState(true);

  React.useEffect(() => {

    const unsubscribe = auth.onAuthStateChanged(async (currentUser) => {

      if (currentUser && !currentUser.isAnonymous) {

        setUser(currentUser);

        const userRef = db.collection("users").doc(currentUser.uid);
        const snap = await userRef.get();

        let data;

        if (!snap.exists) {

          const isAdmin = ADMIN_NAMES.some(name =>
            currentUser.displayName?.toLowerCase().includes(name.toLowerCase())
          );

          data = {
            uid: currentUser.uid,
            displayName: currentUser.displayName,
            email: currentUser.email,
            status: isAdmin ? "approved" : "pending",
            isAdmin
          };

          await userRef.set(data);

        } else {
          data = snap.data();
        }

        setUserData(data);

      } else if (!currentUser) {

        await auth.signInAnonymously();

      }

      setLoading(false);

    });

    return () => unsubscribe();

  }, []);

  const loginGoogle = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    await auth.signInWithPopup(provider);
  };

  const logout = async () => {
    await auth.signOut();
  };

  return { user, userData, loading, loginGoogle, logout };
};


const Escala = () => {

  const [escala, setEscala] = React.useState([]);

  React.useEffect(() => {

    const unsubscribe = db.collection("escala")
      .orderBy("data")
      .onSnapshot(snapshot => {

        const dados = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        setEscala(dados);
      });

    return () => unsubscribe();

  }, []);

  return (
    <div className="bg-white shadow-xl rounded-xl p-6">

      <h2 className="text-xl font-bold mb-4">Escala do Mês</h2>

      {escala.length === 0 ? (
        <p className="text-gray-500">Nenhuma escala cadastrada.</p>
      ) : (
        <table className="w-full border-collapse">
          <thead>
            <tr className="bg-gray-100">
              <th className="p-2 border">Data</th>
              <th className="p-2 border">Nome</th>
              <th className="p-2 border">Turno</th>
            </tr>
          </thead>
          <tbody>
            {escala.map(item => (
              <tr key={item.id}>
                <td className="p-2 border">{item.data}</td>
                <td className="p-2 border">{item.nome}</td>
                <td className="p-2 border">{item.turno}</td>
              </tr>
            ))}
          </tbody>
        </table>
      )}

    </div>
  );
};


const App = () => {

  const { user, userData, loading, loginGoogle, logout } = useAuthUser();

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <i className="fas fa-spinner fa-spin text-4xl text-indigo-600"></i>
      </div>
    );
  }

  if (user?.isAnonymous) {
    return (
      <div className="min-h-screen flex items-center justify-center p-6">
        <div className="bg-white shadow-xl rounded-xl p-8 w-full max-w-md text-center">

          <h1 className="text-2xl font-bold mb-4">Escala DNIZ</h1>

          <button
            onClick={loginGoogle}
            className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold w-full"
          >
            Entrar com Google
          </button>

        </div>
      </div>
    );
  }

  if (userData?.status !== "approved") {
    return (
      <div className="min-h-screen flex items-center justify-center p-6">
        <div className="bg-white shadow-xl rounded-xl p-8 w-full max-w-md text-center">

          <h1 className="text-xl font-bold mb-4">Aguardando Aprovação</h1>

          <button
            onClick={logout}
            className="bg-red-500 text-white px-6 py-3 rounded-lg font-bold w-full"
          >
            Sair
          </button>

        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen p-6">

      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">Escala DNIZ</h1>

        <button
          onClick={logout}
          className="bg-red-500 text-white px-4 py-2 rounded-lg"
        >
          Sair
        </button>
      </div>

      <Escala />

    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);

</script>
</body>
</html>