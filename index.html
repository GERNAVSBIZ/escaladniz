<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Escala de Serviço</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        #table-container { max-height: 70vh; overflow: auto; }
        .selected-for-swap { outline: 3px solid #3b82f6; outline-offset: -2px; border-radius: 2px; }
        #toast-notification { transition: opacity 0.5s, transform 0.5s; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <div class="text-center md:text-left">
                <img src="dniz.png" alt="Logo DNIZ" class="h-16 mx-auto md:mx-0" onerror="this.onerror=null;this.src='https://placehold.co/150x64/ffffff/000000?text=DNIZ';">
                <h1 class="text-2xl font-bold text-gray-800 mt-1">ESCALAS DNIZ</h1>
            </div>
            <div id="auth-container" class="mt-4 md:mt-0 flex items-center gap-4">
                <p id="user-info" class="text-sm font-medium text-gray-600 hidden"></p>
                <button id="login-btn" class="bg-white text-gray-700 font-bold py-2 px-4 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors shadow-sm flex items-center gap-2">
                    <i class="fab fa-google"></i> Login com Google
                </button>
                <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors shadow-sm hidden">
                    Sair
                </button>
            </div>
        </header>

        <!-- Admin Panel -->
        <section id="admin-panel" class="mb-8 bg-orange-100 border-l-4 border-orange-500 p-4 rounded-lg hidden">
            <h2 class="text-xl font-semibold text-orange-800 mb-4">Painel do Administrador</h2>
            <h3 class="font-semibold text-gray-700 mb-2">Usuários Pendentes de Aprovação:</h3>
            <div id="pending-users-list" class="space-y-2">
                <p class="text-gray-500">Nenhum usuário pendente.</p>
            </div>
        </section>

        <!-- Main app content, hidden until login -->
        <div id="app-content" class="hidden">
             <!-- Notifications Section -->
            <section id="notifications-section" class="mb-6"></section>

            <div id="admin-controls" class="flex justify-end mb-4">
                 <label for="csv-upload" class="cursor-pointer bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors shadow-md flex items-center gap-2">
                    <i class="fas fa-upload"></i>
                    Carregar Nova Escala (CSV)
                </label>
                <input type="file" id="csv-upload" class="hidden" accept=".csv">
            </div>

            <section id="saved-schedules-section" class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Escalas Salvas (Compartilhadas)</h2>
                <div id="saved-schedules-list" class="flex flex-wrap gap-3 items-center">
                    <p id="loading-schedules" class="text-gray-500">Carregando escalas salvas...</p>
                </div>
            </section>

            <div id="summary-section" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4"><div class="bg-indigo-100 p-3 rounded-full"><i class="fas fa-users fa-2x text-indigo-600"></i></div><div><p class="text-gray-500 text-sm">Operadores</p><p id="total-operators" class="text-2xl font-bold text-gray-800">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4"><div class="bg-purple-100 p-3 rounded-full"><i class="fas fa-briefcase fa-2x text-purple-600"></i></div><div><p class="text-gray-500 text-sm">Turnos de Trabalho</p><p id="total-shifts" class="text-2xl font-bold text-gray-800">0</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4"><div class="bg-sky-100 p-3 rounded-full"><i class="fas fa-calendar-day fa-2x text-sky-600"></i></div><div><p class="text-gray-500 text-sm">Mês da Escala</p><p id="scale-month" class="text-2xl font-bold text-gray-800">-</p></div></div>
                <div class="bg-white p-6 rounded-xl shadow-lg flex items-center gap-4"><div class="bg-amber-100 p-3 rounded-full"><i class="fas fa-hourglass-half fa-2x text-amber-600"></i></div><div><p class="text-gray-500 text-sm">Horas Totais (Mês)</p><p id="total-hours" class="text-2xl font-bold text-gray-800">0h</p></div></div>
            </div>
            
            <main id="main-content" class="bg-white p-6 rounded-xl shadow-lg hidden">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 id="table-title" class="text-xl font-semibold text-gray-700">Escala Mensal</h2>
                    <div id="action-buttons" class="flex gap-2 flex-wrap">
                        <button id="swap-shifts-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700"><i class="fas fa-exchange-alt mr-2"></i><span id="swap-btn-text">Trocar Turnos</span></button>
                        <button id="export-csv" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 hidden"><i class="fas fa-file-download mr-2"></i>Exportar CSV</button>
                        <button id="delete-schedule-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700"><i class="fas fa-trash-alt mr-2"></i>Deletar Escala</button>
                    </div>
                </div>
                <div id="table-container" class="custom-scrollbar border border-gray-200 rounded-lg">
                    <table id="schedule-table" class="w-full text-center text-sm"></table>
                </div>
            </main>

            <section id="stats-section" class="mt-8 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Estatísticas do Mês</h2>
                <div id="operator-stats" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
            </section>
        </div>

        <div id="initial-message" class="text-center py-20">
            <i class="fas fa-sign-in-alt fa-4x text-gray-400 mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-600">Bem-vindo!</h2>
            <p class="text-gray-500 mt-2">Faça login com sua conta Google para gerenciar as escalas.</p>
        </div>
        
        <div id="pending-approval-message" class="text-center py-20 hidden">
            <i class="fas fa-clock fa-4x text-yellow-500 mb-4"></i>
            <h2 class="text-2xl font-semibold text-gray-600">Aguardando Aprovação</h2>
            <p class="text-gray-500 mt-2">Sua conta foi registrada e está aguardando a aprovação de um administrador.</p>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm">
            <h3 class="text-lg font-bold mb-4">Alterar Turno</h3>
            <p class="mb-2"><strong>Operador:</strong> <span id="modal-operator"></span></p>
            <p class="mb-4"><strong>Data:</strong> <span id="modal-date"></span></p>
            <select id="modal-shift-select" class="w-full p-2 border rounded-md"></select>
            <div class="mt-6 flex justify-end gap-4">
                <button id="modal-cancel" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="modal-save" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Salvar</button>
            </div>
        </div>
    </div>

    <div id="delete-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h3 class="text-lg font-bold mb-2 text-gray-800">Confirmar Exclusão</h3>
            <p class="mb-6 text-gray-600">Tem certeza que deseja deletar a escala <strong id="delete-schedule-name" class="text-red-600"></strong>? Esta ação não pode ser desfeita.</p>
            <div class="mt-6 flex justify-end gap-4">
                <button id="delete-cancel-btn" class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Cancelar</button>
                <button id="delete-confirm-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">Deletar</button>
            </div>
        </div>
    </div>

    <div id="toast-notification" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-10">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="toast-message"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const SHIFT_CONFIG = {
            // Turnos de trabalho originais
            'A': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Manhã' },
            'B': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Tarde' },
            'C': { hours: 8, color: 'bg-blue-200', text: 'text-blue-800', name: 'Noite' },
            'HA': { hours: 8, color: 'bg-green-200', text: 'text-green-800', name: 'Hor. Adm.' },

            // Novos turnos numerados
            'A1': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 1 (00-08)' },
            'B1': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 2 (08-16)' },
            'C1': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 3 (16-00)' },
            'A2': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 4 (01-09)' },
            'B2': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 5 (09-17)' },
            'C2': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 6 (17-01)' },
            'A3': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 7 (02-10)' },
            'B3': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 8 (10-18)' },
            'C3': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 9 (18-02)' },
            'A4': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 10 (03-11)' },
            'B4': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 11 (11-19)' },
            'C4': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 12 (19-03)' },
            'A5': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 13 (04-12)' },
            'B5': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 14 (12-20)' },
            'C5': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 15 (20-04)' },
            'A6': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 16 (05-13)' },
            'B6': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 17 (13-21)' },
            'C6': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 18 (21-05)' },
            'A7': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 19 (06-14)' },
            'B7': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 20 (14-22)' },
            'C7': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 21 (22-06)' },
            'A8': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Turno 22 (07-15)' },
            'B8': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Turno 23 (15-23)' },
            'C8': { hours: 8, color: 'bg-indigo-200', text: 'text-indigo-800', name: 'Turno 24 (23-07)' },

            // Folgas e dispensas originais
            'X': { hours: 0, color: 'bg-gray-200', text: 'text-gray-800', name: 'Folga' },
            'FE': { hours: 0, color: 'bg-pink-200', text: 'text-pink-800', name: 'Férias' },
            'FC': { hours: 0, color: 'bg-purple-200', text: 'text-purple-800', name: 'Folga Comp.' },
            'FF': { hours: 0, color: 'bg-orange-200', text: 'text-orange-800', name: 'Folga Feriado' },

            // Novas folgas, licenças e dispensas
            'AP': { hours: 0, color: 'bg-teal-200', text: 'text-teal-800', name: 'Abono de Ponto' },
            'AM': { hours: 0, color: 'bg-red-200', text: 'text-red-800', name: 'Atestado Médico' },
            'LP': { hours: 0, color: 'bg-fuchsia-200', text: 'text-fuchsia-800', name: 'Licença Paternidade' },
            'LM': { hours: 0, color: 'bg-rose-200', text: 'text-rose-800', name: 'Licença Médica' },
            'LG': { hours: 0, color: 'bg-violet-200', text: 'text-violet-800', name: 'Licença Gala' },
            'LJ': { hours: 0, color: 'bg-stone-300', text: 'text-stone-800', name: 'Licença Luto' },
            'SB': { hours: 0, color: 'bg-slate-300', text: 'text-slate-800', name: 'Sobreaviso' },

            // Novos turnos de trabalho especiais
            'CS': { hours: 8, color: 'bg-lime-200', text: 'text-lime-800', name: 'Convocação Superior' },
            'CT': { hours: 8, color: 'bg-emerald-200', text: 'text-emerald-800', name: 'Curso Teórico' },
            'CP': { hours: 8, color: 'bg-emerald-300', text: 'text-emerald-900', name: 'Curso Prático' },
            'TR': { hours: 8, color: 'bg-cyan-200', text: 'text-cyan-800', name: 'Treinamento' },
            'SR': { hours: 8, color: 'bg-cyan-300', text: 'text-cyan-900', name: 'Serviço Remoto' },
            
            // Turno vazio padrão
            '---': { hours: 0, color: 'bg-gray-100', text: 'text-gray-500', name: 'Vazio' }
        };

        const ADMIN_NAMES = ["Wilkson", "Adriano"];
        const MANAGER_NAME = "WILKSON";

        let scheduleData=[],dateHeaders=[],monthName='',year='',originalCsvLines=[],isSwapMode=false,firstSelection=null,currentEditCell=null,currentScheduleId=null,pendingSwaps=[];
        
        const fileInput=document.getElementById('csv-upload'),initialMessage=document.getElementById('initial-message'),summarySection=document.getElementById('summary-section'),mainContent=document.getElementById('main-content'),statsSection=document.getElementById('stats-section'),scheduleTable=document.getElementById('schedule-table'),operatorStatsContainer=document.getElementById('operator-stats'),exportButton=document.getElementById('export-csv'),swapShiftsBtn=document.getElementById('swap-shifts-btn'),editModal=document.getElementById('edit-modal'),modalOperator=document.getElementById('modal-operator'),modalDate=document.getElementById('modal-date'),modalShiftSelect=document.getElementById('modal-shift-select'),modalSave=document.getElementById('modal-save'),modalCancel=document.getElementById('modal-cancel'),savedSchedulesList=document.getElementById('saved-schedules-list'),loadingSchedules=document.getElementById('loading-schedules'),appContent=document.getElementById('app-content'),loginBtn=document.getElementById('login-btn'),logoutBtn=document.getElementById('logout-btn'),userInfo=document.getElementById('user-info'),deleteScheduleBtn=document.getElementById('delete-schedule-btn'),deleteConfirmModal=document.getElementById('delete-confirm-modal'),deleteScheduleName=document.getElementById('delete-schedule-name'),deleteCancelBtn=document.getElementById('delete-cancel-btn'),deleteConfirmBtn=document.getElementById('delete-confirm-btn'),notificationsSection=document.getElementById('notifications-section'), adminControls = document.getElementById('admin-controls'), actionButtons = document.getElementById('action-buttons'), adminPanel = document.getElementById('admin-panel'), pendingUsersList = document.getElementById('pending-users-list'), pendingApprovalMessage = document.getElementById('pending-approval-message');

        let auth,db,userId,projectId,currentUserDisplayName, isUserAdmin = false;

        async function initializeFirebase(){try{const firebaseConfig={apiKey:"AIzaSyApoDIAXZ5_6GlytJp6IyesM-6epXDqo6k",authDomain:"dashboard-escala.firebaseapp.com",projectId:"dashboard-escala",storageBucket:"dashboard-escala.appspot.com",messagingSenderId:"451393122794",appId:"1:451393122794:web:24f125f11ef3260b770293"};projectId=firebaseConfig.projectId;const app=initializeApp(firebaseConfig);auth=getAuth(app);db=getFirestore(app);handleAuthState()}catch(error){console.error("Firebase initialization failed:",error);initialMessage.innerHTML=`<i class="fas fa-exclamation-triangle fa-4x text-red-400 mb-4"></i><h2 class="text-2xl font-semibold text-gray-600">Erro de Configuração</h2><p class="text-gray-500 mt-2">Não foi possível conectar ao Firebase.</p>`}}
        
        function handleAuthState(){onAuthStateChanged(auth,async(user)=>{if(user){userId=user.uid;currentUserDisplayName=user.displayName;userInfo.textContent=`Olá, ${user.displayName||'Usuário'}`;loginBtn.classList.add('hidden');userInfo.classList.remove('hidden');logoutBtn.classList.remove('hidden');await checkUserStatus(user)}else{userId=null;currentUserDisplayName=null;isUserAdmin=false;loginBtn.classList.remove('hidden');userInfo.classList.add('hidden');logoutBtn.classList.add('hidden');appContent.classList.add('hidden');adminPanel.classList.add('hidden');pendingApprovalMessage.classList.add('hidden');initialMessage.classList.remove('hidden')}})}
        
        async function checkUserStatus(user) {
            const userRef = doc(db, `artifacts/${projectId}/users`, user.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                const isAdmin = ADMIN_NAMES.some(admin => user.displayName.toLowerCase().includes(admin.toLowerCase()));
                await setDoc(userRef, {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    status: isAdmin ? 'approved' : 'pending',
                    isAdmin: isAdmin
                });
                if (isAdmin) {
                    isUserAdmin = true;
                    showFullApp();
                } else {
                    showPendingApprovalMessage();
                }
            } else {
                const userData = userDoc.data();
                isUserAdmin = userData.isAdmin || false;
                if (userData.status === 'approved') {
                    showFullApp();
                } else {
                    showPendingApprovalMessage();
                }
            }
        }

        async function showFullApp() {
            appContent.classList.remove('hidden');
            initialMessage.classList.add('hidden');
            pendingApprovalMessage.classList.add('hidden');
            updateUIVisibility();
            await loadSavedSchedules();
            if (currentScheduleId) await loadPendingSwaps();
            if (isUserAdmin) await loadPendingUsers();
        }

        function showPendingApprovalMessage() {
            appContent.classList.add('hidden');
            initialMessage.classList.add('hidden');
            pendingApprovalMessage.classList.remove('hidden');
        }

        function updateUIVisibility() {
            if (isUserAdmin) {
                adminControls.classList.remove('hidden');
                deleteScheduleBtn.classList.remove('hidden');
                exportButton.classList.remove('hidden');
            } else {
                adminControls.classList.add('hidden');
                deleteScheduleBtn.classList.add('hidden');
                exportButton.classList.add('hidden');
            }
        }

        async function handleLogin(){const provider=new GoogleAuthProvider();try{await signInWithPopup(auth,provider)}catch(error){console.error("Google sign-in failed:",error)}}
        async function handleLogout(){try{await signOut(auth)}catch(error){console.error("Sign out failed:",error)}}
        async function saveScheduleToFirestore(){if(!userId||!currentScheduleId)return;const schedulePayload={scheduleData,dateHeaders,monthName,year,originalCsvLines,lastUpdated:(new Date).toISOString()};try{const scheduleRef=doc(db,`artifacts/${projectId}/schedules`,currentScheduleId);await setDoc(scheduleRef,schedulePayload);showToast("Escala salva com sucesso!");await loadSavedSchedules()}catch(error){console.error("Error saving schedule to Firestore:",error);showToast("Erro ao salvar a escala.",true)}}
        
        async function loadSavedSchedules(){
            if(!userId)return;
            try {
                const schedulesCol=collection(db,`artifacts/${projectId}/schedules`);
                const scheduleSnapshot=await getDocs(schedulesCol);
                savedSchedulesList.innerHTML='';
                if(scheduleSnapshot.empty){
                    savedSchedulesList.innerHTML='<p class="text-gray-500">Nenhuma escala salva encontrada.</p>'
                } else {
                    const schedules=scheduleSnapshot.docs.map(doc=>({id:doc.id,...doc.data()}));
                    schedules.sort((a, b) => a.id.localeCompare(b.id)); // Sort by new ID
                    schedules.forEach(schedule=>{
                        const button=document.createElement('button');
                        button.className="bg-white text-gray-700 font-semibold py-2 px-4 border border-gray-300 rounded-lg hover:bg-gray-100";
                        button.textContent=schedule.id;
                        button.onclick=()=>loadScheduleFromFirestore(schedule.id);
                        savedSchedulesList.appendChild(button)
                    })
                }
            } catch(error) {
                console.error("Error loading saved schedules:",error);
                savedSchedulesList.innerHTML='<p class="text-red-500">Erro ao carregar escalas.</p>'
            }
        }

        async function loadScheduleFromFirestore(scheduleId){try{const scheduleRef=doc(db,`artifacts/${projectId}/schedules`,scheduleId);const docSnap=await getDoc(scheduleRef);if(docSnap.exists()){const data=docSnap.data();({scheduleData,dateHeaders,monthName,year,originalCsvLines}=data);currentScheduleId=scheduleId;displayData();await loadPendingSwaps()}}catch(error){console.error("Error loading schedule from Firestore:",error)}}
        
        async function handleFileUpload(event){
            const file=event.target.files[0];
            if(!file)return;
            const reader=new FileReader;
            reader.onload=async e=>{
                originalCsvLines=e.target.result.split(/\r\n?|\n/);
                parseCSV(originalCsvLines);
                if(scheduleData.length>0){
                    const MONTH_MAP_NUM = {'JANEIRO':'01','FEVEREIRO':'02','MARÇO':'03','ABRIL':'04','MAIO':'05','JUNHO':'06','JULHO':'07','AGOSTO':'08','SETEMBRO':'09','OUTUBRO':'10','NOVEMBRO':'11','DEZEMBRO':'12'};
                    const monthNum = MONTH_MAP_NUM[monthName.toUpperCase()];
                    currentScheduleId=`${monthNum}-${year}-${monthName.toUpperCase()}`; // New format
                    displayData();
                    await saveScheduleToFirestore();
                }
            };
            reader.readAsText(file,'ISO-8859-1')
        }

        function parseCSV(lines){scheduleData=[];dateHeaders=[];year='';monthName='';let DATE_ROW=-1,OPERATOR_DATA_START_ROW=-1;for(let i=10;i<lines.length;i++){const parts=lines[i].split(';');if(parts[0].trim()===''&&parts.length>15&&!isNaN(parseInt(parts[1]?.trim(),10))){DATE_ROW=i;OPERATOR_DATA_START_ROW=i+1;break}}if(DATE_ROW===-1){console.error("Cabeçalho de data não localizado.");return}try{const monthLine=lines[0].split(';')[0].trim();if(monthLine)monthName=monthLine.charAt(0).toUpperCase()+monthLine.slice(1).toLowerCase();const yearLine=lines[3].split(';')[0].trim();if(/^20\d{2}$/.test(yearLine))year=yearLine}catch(e){console.error("Erro ao ler metadados.")}dateHeaders=lines[DATE_ROW].split(';').slice(1).map(d=>d.trim().replace(/"/g,'')).filter(d=>d&&!isNaN(d));if(dateHeaders.length===0){console.error("Datas válidas não encontradas.");return}for(let i=OPERATOR_DATA_START_ROW;i<lines.length;i++){const line=lines[i].trim();if(!line)continue;const parts=line.split(';');const operatorName=parts[0].trim().replace(/"/g,'');if(operatorName&&operatorName.length>2&&isNaN(operatorName)){const shifts=parts.slice(1,dateHeaders.length+1).map(s=>{const cleanedShift=s.trim().replace(/"/g,'');return SHIFT_CONFIG.hasOwnProperty(cleanedShift)?cleanedShift:'---'});if(shifts.length===dateHeaders.length)scheduleData.push({name:operatorName,shifts})}}}
        function displayData(){summarySection.classList.remove('hidden');mainContent.classList.remove('hidden');statsSection.classList.remove('hidden');document.getElementById('table-title').textContent=`Escala Mensal - ${monthName} ${year}`;renderTable();updateAllStats();populateModalSelect()}
        function getDayStatusArray(){const dayStatus=[];let currentStatus='previous';for(let i=0;i<dateHeaders.length;i++){if(i>0&&parseInt(dateHeaders[i])<parseInt(dateHeaders[i-1])){currentStatus=currentStatus==='previous'?'current':'next'}if(dateHeaders[i]==='1'&&currentStatus==='previous'){currentStatus='current'}dayStatus.push(currentStatus)}return dayStatus}
        
        function getFullDateForCell(dayIndex) {
            const MONTH_MAP={'JANEIRO':0,'FEVEREIRO':1,'MARÇO':2,'ABRIL':3,'MAIO':4,'JUNHO':5,'JULHO':6,'AGOSTO':7,'SETEMBRO':8,'OUTUBRO':9,'NOVEMBRO':10,'DEZEMBRO':11};
            const monthIndex=MONTH_MAP[monthName.toUpperCase()];
            const dayStatus=getDayStatusArray();
            let effectiveMonth=monthIndex;
            if(dayStatus[dayIndex]==='previous')effectiveMonth-=1;
            if(dayStatus[dayIndex]==='next')effectiveMonth+=1;
            return new Date(year,effectiveMonth,parseInt(dateHeaders[dayIndex]));
        }

        function renderTable(){const dayStatus=getDayStatusArray();const today=new Date;today.setHours(0,0,0,0);const currentDay=today.getDate();const currentMonth=today.getMonth();const currentYear=today.getFullYear();let html='<thead class="sticky top-0 z-20"><tr class="bg-gray-200"><th class="p-2 font-semibold text-left sticky left-0 bg-gray-200 z-30" rowspan="2">Operador</th>';dateHeaders.forEach((day,index)=>{const cellDate = getFullDateForCell(index); let weekDay = cellDate.toLocaleDateString('pt-BR',{weekday:'short'}).replace('.','').slice(0,3); const headerColor=dayStatus[index]==='current'?'text-gray-600':'text-gray-400';html+=`<th class="p-1 font-medium text-xs ${headerColor}">${weekDay}</th>`});html+='</tr><tr class="bg-gray-100">';dateHeaders.forEach((day,index)=>{const isCurrentMonthDay=dayStatus[index]==='current';const cellDate = getFullDateForCell(index); const isToday=isCurrentMonthDay&&cellDate.getTime() === today.getTime();const headerColor=isCurrentMonthDay?'':'text-gray-400';const todayHeaderClass=isToday?'bg-blue-500 text-white rounded-full':'';html+=`<th class="p-2 font-semibold text-sm ${headerColor}"><span class="inline-block w-6 h-6 leading-6 ${todayHeaderClass}">${day}</span></th>`});html+='</tr></thead><tbody>';scheduleData.forEach((operator,opIndex)=>{html+=`<tr class="border-b last:border-b-0 hover:bg-gray-50"><td class="p-2 font-medium text-gray-800 text-left sticky left-0 bg-white hover:bg-gray-50 z-10 whitespace-nowrap border-r">${operator.name}</td>`;operator.shifts.forEach((shift,dayIndex)=>{const config=SHIFT_CONFIG[shift]||SHIFT_CONFIG['---'];const isCurrentMonthDay=dayStatus[dayIndex]==='current';const cellDate = getFullDateForCell(dayIndex); const isToday=isCurrentMonthDay&&cellDate.getTime() === today.getTime();const bgColor=isCurrentMonthDay?config.color:'bg-gray-200';const textColor=isCurrentMonthDay?config.text:'text-gray-500';let extraCellClasses=[];if(isToday){extraCellClasses.push('ring-2 ring-blue-500 z-10')}const pendingSwap=pendingSwaps.find(s=>(parseInt(s.initiator.opIndex)===opIndex&&parseInt(s.initiator.dayIndex)===dayIndex)||(parseInt(s.recipient.opIndex)===opIndex&&parseInt(s.recipient.dayIndex)===dayIndex));if(pendingSwap){if(parseInt(pendingSwap.initiator.opIndex)===opIndex&&parseInt(pendingSwap.initiator.dayIndex)===dayIndex){extraCellClasses.push('ring-2 ring-blue-500 animate-pulse')}else{extraCellClasses.push('ring-2 ring-green-500 animate-pulse')}}const cellClasses=extraCellClasses.join(' ');html+=`<td class="p-0 border-r last:border-r-0"><div class="relative w-full h-full p-2 font-mono font-bold cursor-pointer transition-transform transform hover:scale-110 ${bgColor} ${textColor} ${cellClasses}" data-op-index="${opIndex}" data-day-index="${dayIndex}" onclick="handleCellClick(this)">${shift}</div></td>`});html+=`</tr>`});html+='</tbody>';scheduleTable.innerHTML=html}
        
        function updateAllStats(){let totalOperators=scheduleData.length,totalShifts=0,totalHours=0;const dayStatus=getDayStatusArray();const operatorStats=scheduleData.map(operator=>{let workedHours=0,workDays=0,offDays=0,vacationDays=0;operator.shifts.forEach((shift,index)=>{if(dayStatus[index]==='current'){const config=SHIFT_CONFIG[shift];if(config){workedHours+=config.hours;if(config.hours>0){workDays++;totalShifts++}else if(['X','FC','FF'].includes(shift)){offDays++}else if(shift==='FE'){vacationDays++}}}});if(operator.name.toUpperCase() !== MANAGER_NAME){totalHours+=workedHours}return{name:operator.name,workedHours,workDays,offDays,vacationDays}});document.getElementById('total-operators').textContent=totalOperators;document.getElementById('total-shifts').textContent=totalShifts;document.getElementById('total-hours').textContent=`${totalHours}h`;document.getElementById('scale-month').textContent=`${monthName} ${year}`;renderOperatorStats(operatorStats)}
        function renderOperatorStats(stats){let html='';stats.forEach(stat=>{html+=`<div class="bg-white p-4 rounded-xl shadow-lg"><h3 class="font-bold text-gray-800">${stat.name}</h3><p class="text-3xl font-bold text-indigo-600 my-2">${stat.workedHours}h</p><div class="text-xs text-gray-500 flex justify-between"><span>Trabalho: ${stat.workDays}</span><span>Folgas: ${stat.offDays}</span><span>Férias: ${stat.vacationDays}</span></div></div>`});operatorStatsContainer.innerHTML=html}
        function populateModalSelect(){modalShiftSelect.innerHTML=Object.entries(SHIFT_CONFIG).map(([key,{name}])=>`<option value="${key}">${key} - ${name}</option>`).join('')}
        
        window.handleCellClick=function(cell){if(isSwapMode){handleSwapSelection(cell)}else{openEditModal(cell)}}
        
        function openEditModal(cell){const{opIndex,dayIndex}=cell.dataset;const operator=scheduleData[opIndex];const operatorName=operator.name;if(isUserAdmin||(currentUserDisplayName&&currentUserDisplayName.toLowerCase().includes(operatorName.toLowerCase()))){currentEditCell=cell;modalOperator.textContent=operator.name;modalDate.textContent=`${dateHeaders[dayIndex]} de ${monthName}`;modalShiftSelect.value=operator.shifts[dayIndex];editModal.classList.remove('hidden')}else{showToast("Você só pode editar os seus próprios turnos.",true)}}
        async function saveShiftChange(){if(!currentEditCell)return;const{opIndex,dayIndex}=currentEditCell.dataset;const newShift=modalShiftSelect.value;scheduleData[opIndex].shifts[dayIndex]=newShift;editModal.classList.add('hidden');updateAllStats();renderTable();await saveScheduleToFirestore()}
        function toggleSwapMode(){isSwapMode=!isSwapMode;const swapBtnText=document.getElementById('swap-btn-text');if(isSwapMode){swapShiftsBtn.classList.replace('bg-blue-600','bg-red-600');swapShiftsBtn.classList.replace('hover:bg-blue-700','hover:bg-red-700');swapBtnText.textContent='Cancelar Troca';scheduleTable.style.cursor='cell'}else{swapShiftsBtn.classList.replace('bg-red-600','bg-blue-600');swapShiftsBtn.classList.replace('hover:bg-red-700','hover:bg-blue-700');swapBtnText.textContent='Trocar Turnos';scheduleTable.style.cursor='default';if(firstSelection){firstSelection.element.classList.remove('selected-for-swap');firstSelection=null}}}
        
        async function handleSwapSelection(cell){
            const { opIndex, dayIndex } = cell.dataset;
            const today = new Date();
            today.setHours(0,0,0,0);
            const cellDate = getFullDateForCell(dayIndex);
            
            if(cellDate < today) {
                showToast("Não é permitido trocar turnos em datas passadas.", true);
                if (firstSelection) {
                    firstSelection.element.classList.remove('selected-for-swap');
                    firstSelection = null;
                }
                return;
            }

            if(!firstSelection){
                firstSelection={opIndex:opIndex,dayIndex:dayIndex,element:cell};
                cell.classList.add('selected-for-swap')
            } else {
                const secondSelection={opIndex:opIndex,dayIndex:dayIndex,element:cell};
                if(firstSelection.opIndex===secondSelection.opIndex&&firstSelection.dayIndex===secondSelection.dayIndex)return;
                const initiator={opIndex:parseInt(firstSelection.opIndex),dayIndex:parseInt(firstSelection.dayIndex),opName:scheduleData[firstSelection.opIndex].name,shift:scheduleData[firstSelection.opIndex].shifts[firstSelection.dayIndex]};
                const recipient={opIndex:parseInt(secondSelection.opIndex),dayIndex:parseInt(secondSelection.dayIndex),opName:scheduleData[secondSelection.opIndex].name,shift:scheduleData[secondSelection.opIndex].shifts[secondSelection.dayIndex]};
                if(initiator.opName===recipient.opName){showToast("Não é possível trocar turnos com você mesmo.",true);firstSelection.element.classList.remove('selected-for-swap');firstSelection=null;return}
                const requestId=`${currentScheduleId}_${initiator.opIndex}-${initiator.dayIndex}_${recipient.opIndex}-${recipient.dayIndex}`;
                const requestData={id:requestId,scheduleId:currentScheduleId,initiator,recipient,status:'pending',timestamp:(new Date).toISOString()};
                await saveSwapRequest(requestData);
                showToast(`Solicitação de troca enviada para ${recipient.opName}.`);
                firstSelection.element.classList.remove('selected-for-swap');
                firstSelection=null;
                toggleSwapMode()
            }
        }

        function showDeleteConfirmModal(){if(!currentScheduleId)return;deleteScheduleName.textContent=currentScheduleId;deleteConfirmModal.classList.remove('hidden')}
        async function handleDeleteSchedule(){if(!userId||!currentScheduleId)return;try{const scheduleRef=doc(db,`artifacts/${projectId}/schedules`,currentScheduleId);await deleteDoc(scheduleRef);showToast("Escala deletada com sucesso!");deleteConfirmModal.classList.add('hidden');resetUI();await loadSavedSchedules()}catch(error){console.error("Error deleting schedule:",error);showToast("Erro ao deletar a escala.",true)}}
        function resetUI(){summarySection.classList.add('hidden');mainContent.classList.add('hidden');statsSection.classList.add('hidden');scheduleData=[];dateHeaders=[];monthName='';year='';originalCsvLines=[];currentScheduleId=null}
        function showToast(message,isError=false){const toast=document.getElementById('toast-notification'),toastMessage=document.getElementById('toast-message');toast.classList.toggle('bg-red-500',isError);toast.classList.toggle('bg-green-500',!isError);toastMessage.textContent=message;toast.classList.remove('opacity-0','translate-y-10');setTimeout(()=>{toast.classList.add('opacity-0','translate-y-10')},3000)}
        function exportToCSV(){if(!originalCsvLines||originalCsvLines.length===0){alert("Não há dados para exportar.");return}let updatedCsvLines=[...originalCsvLines];let DATE_ROW=-1,OPERATOR_DATA_START_ROW=-1;for(let i=10;i<updatedCsvLines.length;i++){const parts=updatedCsvLines[i].split(';');if(parts[0].trim()===''&&parts.length>15&&!isNaN(parseInt(parts[1]?.trim(),10))){DATE_ROW=i;OPERATOR_DATA_START_ROW=i+1;break}}if(OPERATOR_DATA_START_ROW===-1){alert("Não foi possível encontrar a linha inicial dos operadores.");return}scheduleData.forEach((operator,opIndex)=>{const rowIndex=OPERATOR_DATA_START_ROW+opIndex;if(updatedCsvLines[rowIndex]){let parts=updatedCsvLines[rowIndex].split(';');parts[0]=operator.name;operator.shifts.forEach((shift,dayIndex)=>{parts[dayIndex+1]=shift});updatedCsvLines[rowIndex]=parts.join(';')}});const csvContent=updatedCsvLines.join('\n');const blob=new Blob([csvContent],{type:'text/csv;charset=utf-8;'});const link=document.createElement("a");const url=URL.createObjectURL(blob);link.setAttribute("href",url);link.setAttribute("download",`escala_atualizada_${monthName.toLowerCase()}_${year}.csv`);document.body.appendChild(link);link.click();document.body.removeChild(link)}
        async function saveSwapRequest(requestData){try{const requestRef=doc(db,`artifacts/${projectId}/swapRequests`,requestData.id);await setDoc(requestRef,requestData);await loadPendingSwaps()}catch(error){console.error("Error saving swap request:",error)}}
        
        async function loadPendingSwaps(){
            if(!userId||!currentScheduleId)return;
            try {
                const requestsCol=collection(db,`artifacts/${projectId}/swapRequests`);
                const requestSnapshot=await getDocs(requestsCol);
                const allSwaps = requestSnapshot.docs.map(doc=>doc.data()).filter(req=>req.scheduleId===currentScheduleId);

                const today = new Date();
                today.setHours(0,0,0,0);
                
                let validSwaps = [];
                for (const swap of allSwaps) {
                    const swapDate = getFullDateForCell(swap.initiator.dayIndex);
                    if (swapDate < today) {
                        await deleteSwapRequest(swap.id, false); // Delete expired without reloading all swaps
                    } else {
                        validSwaps.push(swap);
                    }
                }
                pendingSwaps = validSwaps;
                
                renderNotifications();
                renderTable();
            } catch(error) {
                console.error("Error loading swap requests:",error)
            }
        }
        
        function renderNotifications(){notificationsSection.innerHTML='';if(!currentUserDisplayName)return;const userRequests=pendingSwaps.filter(req=>currentUserDisplayName.toLowerCase().includes(req.recipient.opName.toLowerCase()));if(userRequests.length>0){let html='<h2 class="text-xl font-semibold text-gray-700 mb-2">Solicitações de Troca Pendentes</h2>';userRequests.forEach(req=>{html+=`<div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-2 flex justify-between items-center"><div><p><strong>${req.initiator.opName}</strong> quer trocar o turno <strong>${req.initiator.shift}</strong> do dia <strong>${dateHeaders[req.initiator.dayIndex]}</strong> pelo seu turno <strong>${req.recipient.shift}</strong> do dia <strong>${dateHeaders[req.recipient.dayIndex]}</strong>.</p></div><div class="flex gap-2"><button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded" onclick="window.handleAcceptSwap('${req.id}')">Aceitar</button><button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded" onclick="window.handleDeclineSwap('${req.id}')">Recusar</button></div></div>`});notificationsSection.innerHTML=html}}
        window.handleAcceptSwap=async function(requestId){const request=pendingSwaps.find(req=>req.id===requestId);if(!request)return;const{initiator,recipient}=request;const shift1=scheduleData[initiator.opIndex].shifts[initiator.dayIndex];const shift2=scheduleData[recipient.opIndex].shifts[recipient.dayIndex];scheduleData[initiator.opIndex].shifts[initiator.dayIndex]=shift2;scheduleData[recipient.opIndex].shifts[recipient.dayIndex]=shift1;await saveScheduleToFirestore();await deleteSwapRequest(requestId);showToast("Troca de turno aceita e efetivada!")}
        window.handleDeclineSwap=async function(requestId){await deleteSwapRequest(requestId);showToast("Solicitação de troca recusada.")}
        async function deleteSwapRequest(requestId, reload = true){try{const requestRef=doc(db,`artifacts/${projectId}/swapRequests`,requestId);await deleteDoc(requestRef);if(reload) await loadPendingSwaps()}catch(error){console.error("Error deleting swap request:",error)}}
        
        async function loadPendingUsers() {
            if (!isUserAdmin) return;
            try {
                const usersCol = collection(db, `artifacts/${projectId}/users`);
                const userSnapshot = await getDocs(usersCol);
                const pendingUsers = userSnapshot.docs.map(doc => doc.data()).filter(user => user.status === 'pending');
                
                if (pendingUsers.length === 0) {
                    adminPanel.classList.add('hidden');
                } else {
                    adminPanel.classList.remove('hidden');
                    pendingUsersList.innerHTML = '';
                    pendingUsers.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.className = 'flex justify-between items-center bg-white p-2 rounded-md';
                        userDiv.innerHTML = `<div><p class="font-semibold">${user.displayName}</p><p class="text-sm text-gray-500">${user.email}</p></div><div class="flex gap-2"><button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded" onclick="window.handleApproveUser('${user.uid}')">Aprovar</button><button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded" onclick="window.handleDenyUser('${user.uid}')">Negar</button></div>`;
                        pendingUsersList.appendChild(userDiv);
                    });
                }
            } catch (error) {
                console.error("Error loading pending users:", error);
            }
        }
        
        window.handleApproveUser = async function(uidToApprove) {
            try {
                const userRef = doc(db, `artifacts/${projectId}/users`, uidToApprove);
                await updateDoc(userRef, { status: 'approved' });
                showToast("Usuário aprovado com sucesso!");
                await loadPendingUsers();
            } catch (error) {
                console.error("Error approving user:", error);
                showToast("Erro ao aprovar usuário.", true);
            }
        }

        window.handleDenyUser = async function(uidToDeny) {
            try {
                const userRef = doc(db, `artifacts/${projectId}/users`, uidToDeny);
                await deleteDoc(userRef);
                showToast("Usuário negado e removido.");
                await loadPendingUsers();
            } catch (error) {
                console.error("Error denying user:", error);
                showToast("Erro ao negar usuário.", true);
            }
        }

        loginBtn.addEventListener('click',handleLogin);logoutBtn.addEventListener('click',handleLogout);fileInput.addEventListener('change',handleFileUpload);exportButton.addEventListener('click',exportToCSV);swapShiftsBtn.addEventListener('click',toggleSwapMode);modalCancel.addEventListener('click',()=>editModal.classList.add('hidden'));modalSave.addEventListener('click',saveShiftChange);deleteScheduleBtn.addEventListener('click',showDeleteConfirmModal);deleteCancelBtn.addEventListener('click',()=>deleteConfirmModal.classList.add('hidden'));deleteConfirmBtn.addEventListener('click',handleDeleteSchedule);

        initializeFirebase();
    </script>
</body>
</html>
