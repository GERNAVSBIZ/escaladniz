<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Escala DNIZ Mobile</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* CSS Reset e Otimizações Mobile */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Padronização de Inputs */
        input[type="date"], input[type="time"], select, input[type="text"], input[type="number"] {
            -webkit-appearance: none; appearance: none; font-size: 16px;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .sticky-col {
            position: sticky; left: 0; background-color: white; z-index: 30;
            border-right: 1px solid #e5e7eb;
            box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
        }
        
        .grayscale-cell {
            filter: grayscale(100%); opacity: 0.5; background-color: #f3f4f6 !important; color: #9ca3af !important;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDocs, getDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuração ---
        const firebaseConfig = {
            apiKey: "AIzaSyApoDIAXZ5_6GlytJp6IyesM-6epXDqo6k",
            authDomain: "dashboard-escala.firebaseapp.com",
            projectId: "dashboard-escala",
            storageBucket: "dashboard-escala.appspot.com",
            messagingSenderId: "451393122794",
            appId: "1:451393122794:web:24f125f11ef3260b770293"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const SHIFT_CONFIG = {
            'A': { hours: 8, color: 'bg-yellow-200', text: 'text-yellow-800', name: 'Manhã' },
            'B': { hours: 8, color: 'bg-sky-200', text: 'text-sky-800', name: 'Tarde' },
            'C': { hours: 8, color: 'bg-blue-200', text: 'text-blue-800', name: 'Noite' },
            'HA': { hours: 8, color: 'bg-green-200', text: 'text-green-800', name: 'Adm' },
            'VS': { hours: 8, color: 'bg-cyan-200', text: 'text-cyan-800', name: 'Viagem' },
            'IS': { hours: 8, color: 'bg-teal-200', text: 'text-teal-800', name: 'Insp. Saúde' },
            'X': { hours: 0, color: 'bg-gray-100', text: 'text-gray-400', name: 'Folga' },
            'CHE': { hours: 0, color: 'bg-purple-200', text: 'text-purple-800', name: 'Comp. Hora' },
            'FC': { hours: 0, color: 'bg-purple-300', text: 'text-purple-900', name: 'Folga Comp.' },
            'FF': { hours: 0, color: 'bg-orange-200', text: 'text-orange-800', name: 'Feriado' },
            'FA': { hours: 0, color: 'bg-gray-300', text: 'text-gray-900', name: 'Ajuste' },
            'FE': { hours: 0, color: 'bg-pink-200', text: 'text-pink-800', name: 'Férias' },
            'R': { hours: 0, color: 'bg-pink-300', text: 'text-pink-900', name: 'Recesso' },
            'AM': { hours: 0, color: 'bg-red-200', text: 'text-red-800', name: 'Atestado' },
            'LM': { hours: 0, color: 'bg-rose-200', text: 'text-rose-800', name: 'Lic. Mat.' },
            'LP': { hours: 0, color: 'bg-fuchsia-200', text: 'text-fuchsia-800', name: 'Lic. Pat.' },
            'SE': { hours: 0, color: 'bg-slate-300', text: 'text-slate-800', name: 'Sobreaviso' },
            '---': { hours: 0, color: 'bg-white', text: 'text-gray-300', name: 'Vazio' }
        };

        const ADMIN_NAMES = ["Wilkson", "Adriano"];

        // --- Hooks ---
        const useAuthUser = () => {
            const [user, setUser] = React.useState(null);
            const [userData, setUserData] = React.useState(null);
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        const userRef = doc(db, `artifacts/${firebaseConfig.projectId}/users`, currentUser.uid);
                        const userSnap = await getDoc(userRef);
                        let data = userSnap.exists() ? userSnap.data() : null;
                        
                        if (!data) {
                            const isAdmin = ADMIN_NAMES.some(name => currentUser.displayName?.toLowerCase().includes(name.toLowerCase()));
                            data = { uid: currentUser.uid, displayName: currentUser.displayName, email: currentUser.email, status: isAdmin ? 'approved' : 'pending', isAdmin: isAdmin };
                            await setDoc(userRef, data);
                        } else if (ADMIN_NAMES.some(name => currentUser.displayName?.toLowerCase().includes(name.toLowerCase())) && !data.isAdmin) {
                            data.isAdmin = true;
                            await updateDoc(userRef, { isAdmin: true });
                        }
                        setUserData(data);
                    } else {
                        setUser(null); setUserData(null);
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const login = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { alert("Erro login: " + e.message); } };
            const logout = async () => await signOut(auth);
            return { user, userData, loading, login, logout };
        };

        // --- Componentes UI ---
        const Button = ({ children, onClick, variant = 'primary', className = '' }) => {
            const variants = {
                primary: 'bg-indigo-600 text-white hover:bg-indigo-700',
                secondary: 'bg-white text-gray-700 border border-gray-300',
                danger: 'bg-red-500 text-white hover:bg-red-600',
                success: 'bg-green-600 text-white hover:bg-green-700'
            };
            return <button onClick={onClick} className={`h-12 px-4 rounded-lg font-medium shadow-sm flex items-center justify-center gap-2 active:scale-95 ${variants[variant]} ${className}`}>{children}</button>;
        };

        const Select = ({ value, onChange, options }) => (
            <div className="w-full relative">
                <select value={value} onChange={onChange} className="w-full h-12 pl-4 pr-10 bg-white border border-gray-300 rounded-lg appearance-none">{options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}</select>
                <div className="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-500"><i className="fas fa-chevron-down text-xs"></i></div>
            </div>
        );

        // --- Helpers de Data ---
        function getDayStatusArray(dateHeaders) {
            const dayStatus = [];
            let currentStatus = 'previous';
            for (let i = 0; i < dateHeaders.length; i++) {
                if (i > 0 && parseInt(dateHeaders[i]) < parseInt(dateHeaders[i-1])) currentStatus = currentStatus === 'previous' ? 'current' : 'next';
                if (dateHeaders[i] === '1' && currentStatus === 'previous') currentStatus = 'current';
                dayStatus.push(currentStatus);
            }
            return dayStatus;
        }

        // --- Função de Geração de PDF (Exatamente Igual ao Modelo) ---
        const generatePDF = (schedule) => {
            if (!schedule) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            const { scheduleData, dateHeaders, monthName, year } = schedule;
            const dayStatuses = getDayStatusArray(dateHeaders);

            // Filtrar apenas dias do mês corrente
            const currentMonthIndices = dayStatuses.map((status, idx) => status === 'current' ? idx : -1).filter(idx => idx !== -1);
            const validHeaders = currentMonthIndices.map(i => dateHeaders[i]);

            // --- CABEÇALHO ---
            doc.setFont("helvetica", "bold");
            doc.setFontSize(14);
            doc.text("NV Serviços de", 14, 15);
            doc.text("BRASIL", 14, 20);
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text("Navegação Aérea", 14, 25);
            doc.text("Aeroporto de Imperatriz - SBIZ", 14, 30);
            doc.text("DNIZ (Dependência da NAV Brasil em Imperatriz)", 14, 35);
            
            doc.setFontSize(8);
            doc.text("SEÇÃO/SETOR: COMUNICAÇÃO - COM/AFIS", 14, 42);
            doc.text("ATIVIDADE: RDO IMPERATRIZ - AFIS-IZ", 14, 46);
            doc.text("LOCAL: IMPERATRIZ - SBIZ", 14, 50);

            // Bloco Direito (Mês/Ano)
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.text("ESCALA CUMPRIDA PARA O MÊS DE", 200, 15);
            doc.setFontSize(14);
            doc.text(monthName.toUpperCase(), 200, 22);
            doc.setFontSize(10);
            doc.text(`ANO: ${year}`, 200, 28);
            doc.text("FL 01", 280, 10, { align: "right" });

            // --- LEGENDA (Resumida para caber) ---
            doc.setFontSize(6);
            let legendY = 15;
            let legendX = 80;
            doc.text("LEGENDA", legendX, legendY);
            // Colunas da legenda
            const legendItems = [
                "A: 00h-08h", "B: 05h-13h", "C: 10h-18h",
                "FC: Folga Comp.", "FE: Férias", "HA: Adm",
                "AM: Atestado", "LM: Lic. Mat.", "X: Folga"
            ];
            legendItems.forEach((item, i) => {
                if(i % 3 === 0 && i !== 0) { legendY += 3; legendX = 80; }
                doc.text(item, legendX, legendY + 4);
                legendX += 25;
            });

            // --- TABELA ---
            const columns = [
                { header: 'IND', dataKey: 'ind' },
                { header: 'NOME', dataKey: 'name' },
                { header: 'MAT.N', dataKey: 'mat' }, // Placeholder
                ...validHeaders.map(day => ({ header: day, dataKey: `d${day}` })),
                { header: 'HORAS', dataKey: 'hours' }
            ];

            const rows = scheduleData.map((op, idx) => {
                const row = { ind: idx + 1, name: op.name, mat: '' }; // Matrícula em branco por enquanto
                let totalHours = 0;
                
                currentMonthIndices.forEach(dayIndex => {
                    const day = dateHeaders[dayIndex];
                    const shift = op.shifts[dayIndex];
                    row[`d${day}`] = shift;
                    if (SHIFT_CONFIG[shift]) totalHours += SHIFT_CONFIG[shift].hours;
                });
                
                row['hours'] = `${totalHours} h`;
                return row;
            });

            doc.autoTable({
                startY: 55,
                head: [columns.map(c => c.header)],
                body: rows.map(r => columns.map(c => r[c.dataKey])),
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1, halign: 'center', valign: 'middle', lineWidth: 0.1, lineColor: [0,0,0] },
                headStyles: { fillColor: [255, 255, 255], textColor: [0, 0, 0], lineWidth: 0.1, lineColor: [0,0,0] },
                columnStyles: {
                    0: { cellWidth: 8 }, // IND
                    1: { halign: 'left', cellWidth: 50 }, // NOME
                    2: { cellWidth: 15 }, // MAT
                    [columns.length - 1]: { fontStyle: 'bold', cellWidth: 15 } // HORAS
                },
                didParseCell: function(data) {
                    if (data.section === 'body' && data.column.index > 2 && data.column.index < columns.length - 1) {
                        const shift = data.cell.raw;
                        // Simular cores aproximadas do Excel/Modelo se desejar, ou manter P&B limpo
                        // if (shift === 'A') data.cell.styles.fillColor = [255, 255, 200];
                    }
                }
            });

            // --- RODAPÉ ---
            const finalY = doc.lastAutoTable.finalY + 5;
            
            doc.setFontSize(8);
            doc.text("OBSERVAÇÕES:", 14, finalY);
            doc.line(14, finalY + 4, 280, finalY + 4);
            doc.line(14, finalY + 9, 280, finalY + 9);
            
            // Assinaturas
            let sigY = finalY + 20;
            doc.text("Assinado eletronicamente por:", 14, sigY);
            
            // Tabela simples de assinaturas no rodapé
            const sigStartY = sigY + 5;
            doc.rect(14, sigStartY, 266, 30); // Caixa
            doc.line(14, sigStartY + 5, 280, sigStartY + 5); // Linha título
            
            doc.setFontSize(7);
            doc.text("Nome do Empregado", 16, sigStartY + 3.5);
            doc.text("Assinatura / Data", 120, sigStartY + 3.5);
            doc.text("Mat. N", 200, sigStartY + 3.5);

            // Preencher com alguns nomes (mockup visual)
            let currentSigY = sigStartY + 9;
            scheduleData.slice(0, 5).forEach((op) => {
                doc.text(op.name, 16, currentSigY);
                doc.line(14, currentSigY + 1, 280, currentSigY + 1); // Linha separadora
                currentSigY += 5;
            });

            doc.save(`ESCALA_CUMPRIDA_${monthName}_${year}.pdf`);
        };

        // --- App Principal ---
        const App = () => {
            const { user, userData, loading, login, logout } = useAuthUser();
            const [activeTab, setActiveTab] = React.useState('home');
            const [currentScheduleId, setCurrentScheduleId] = React.useState(null);
            const [schedule, setSchedule] = React.useState(null);
            const [schedulesList, setSchedulesList] = React.useState([]);
            const [pendingSwaps, setPendingSwaps] = React.useState([]);
            const [pendingUsers, setPendingUsers] = React.useState([]);
            const [isEditModalOpen, setEditModalOpen] = React.useState(false);
            const [selectedCell, setSelectedCell] = React.useState(null);
            const [swapMode, setSwapMode] = React.useState(false);
            const [swapSelection, setSwapSelection] = React.useState(null);
            const [toast, setToast] = React.useState(null);

            const showToast = (msg, type = 'success') => { setToast({ msg, type }); setTimeout(() => setToast(null), 3000); };

            // Carregamento Inicial
            React.useEffect(() => { loadSchedulesList(); }, []);
            React.useEffect(() => { if (user && userData?.isAdmin) loadPendingUsers(); }, [user, userData]);
            React.useEffect(() => { if (currentScheduleId) { loadSchedule(currentScheduleId); loadSwapRequests(currentScheduleId); } else setSchedule(null); }, [currentScheduleId]);

            // Auto-selecionar mês atual
            React.useEffect(() => {
                if (schedulesList.length > 0 && !currentScheduleId) {
                    const today = new Date();
                    const monthNames = ['JANEIRO','FEVEREIRO','MARÇO','ABRIL','MAIO','JUNHO','JULHO','AGOSTO','SETEMBRO','OUTUBRO','NOVEMBRO','DEZEMBRO'];
                    const currentId = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${monthNames[today.getMonth()]}`;
                    setCurrentScheduleId(schedulesList.includes(currentId) ? currentId : schedulesList[schedulesList.length - 1]);
                }
            }, [schedulesList]);

            const loadSchedulesList = async () => {
                try {
                    const snap = await getDocs(collection(db, `artifacts/${firebaseConfig.projectId}/schedules`));
                    setSchedulesList(snap.docs.map(d => d.id).sort());
                } catch (e) { console.error(e); }
            };

            const loadSchedule = async (id) => {
                try {
                    const docSnap = await getDoc(doc(db, `artifacts/${firebaseConfig.projectId}/schedules`, id));
                    if (docSnap.exists()) setSchedule(docSnap.data());
                } catch (e) { console.error(e); }
            };

            const loadSwapRequests = async (scheduleId) => {
                try {
                    const snap = await getDocs(collection(db, `artifacts/${firebaseConfig.projectId}/swapRequests`));
                    setPendingSwaps(snap.docs.map(d => d.data()).filter(r => r.scheduleId === scheduleId));
                } catch (e) { console.error(e); }
            };

            const loadPendingUsers = async () => {
                try {
                    const snap = await getDocs(collection(db, `artifacts/${firebaseConfig.projectId}/users`));
                    setPendingUsers(snap.docs.map(d => d.data()).filter(u => u.status === 'pending'));
                } catch (e) { console.error(e); }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const lines = event.target.result.split(/\r\n?|\n/);
                    let scheduleData=[], dateHeaders=[], monthName='', year='', DATE_ROW=-1, DATA_START=-1;
                    
                    for(let i=10;i<lines.length;i++){
                        const parts=lines[i].split(';');
                        if(parts[0].trim()===''&&parts.length>15&&!isNaN(parseInt(parts[1]?.trim(),10))){ DATE_ROW=i; DATA_START=i+1; break; }
                    }
                    if(DATE_ROW === -1) { showToast('CSV inválido', 'error'); return; }

                    try {
                        const mLine = lines[0].split(';')[0].trim();
                        monthName = mLine.charAt(0).toUpperCase() + mLine.slice(1).toLowerCase();
                        year = lines[3].split(';')[0].trim().match(/^20\d{2}$/) ? lines[3].split(';')[0].trim() : new Date().getFullYear();
                    } catch(e) {}

                    dateHeaders = lines[DATE_ROW].split(';').slice(1).map(d=>d.trim().replace(/"/g,'')).filter(d=>d&&!isNaN(d));

                    for(let i=DATA_START; i<lines.length; i++){
                        const line=lines[i].trim();
                        if(!line) continue;
                        const parts=line.split(';');
                        const operatorName=parts[0].trim().replace(/"/g,'');
                        if(operatorName.length>2 && isNaN(operatorName)){
                            const shifts = parts.slice(1, dateHeaders.length+1).map(s => { const cs = s.trim().replace(/"/g,''); return SHIFT_CONFIG[cs] ? cs : '---'; });
                            if(shifts.length === dateHeaders.length) scheduleData.push({name:operatorName, shifts});
                        }
                    }

                    const MONTH_MAP = {'JANEIRO':'01','FEVEREIRO':'02','MARÇO':'03','ABRIL':'04','MAIO':'05','JUNHO':'06','JULHO':'07','AGOSTO':'08','SETEMBRO':'09','OUTUBRO':'10','NOVEMBRO':'11','DEZEMBRO':'12'};
                    const newId = `${year}-${MONTH_MAP[monthName.toUpperCase()]}-${monthName.toUpperCase()}`;
                    
                    await setDoc(doc(db, `artifacts/${firebaseConfig.projectId}/schedules`, newId), { scheduleData, dateHeaders, monthName, year });
                    showToast('Escala carregada!');
                    await loadSchedulesList();
                    setCurrentScheduleId(newId);
                };
                reader.readAsText(file, 'ISO-8859-1');
            };

            const handleCellClick = (opIndex, dayIndex, opName, shift, isCurrentMonth) => {
                if (!user || userData?.status !== 'approved') return showToast("Faça login.", "error");
                if (!isCurrentMonth) return;

                if (swapMode) {
                    if (!swapSelection) {
                        setSwapSelection({ opIndex, dayIndex, opName, shift });
                        showToast("Selecione destino");
                    } else {
                        if (swapSelection.opIndex === opIndex && swapSelection.dayIndex === dayIndex) { setSwapSelection(null); return; }
                        const requestData = {
                            id: `${currentScheduleId}_${Date.now()}`,
                            scheduleId: currentScheduleId,
                            initiator: swapSelection,
                            recipient: { opIndex, dayIndex, opName, shift },
                            status: 'pending'
                        };
                        setDoc(doc(db, `artifacts/${firebaseConfig.projectId}/swapRequests`, requestData.id), requestData)
                            .then(() => { showToast("Solicitação enviada!"); setSwapMode(false); setSwapSelection(null); loadSwapRequests(currentScheduleId); });
                    }
                } else if (userData.isAdmin || userData.displayName.toLowerCase().includes(opName.toLowerCase())) {
                    setSelectedCell({ opIndex, dayIndex, opName, shift });
                    setEditModalOpen(true);
                } else showToast("Apenas seus turnos.", "error");
            };

            // Scroll Automático
            const ScrollToToday = ({ dateHeaders, monthName }) => {
                const scrollRef = React.useRef(null);
                React.useEffect(() => {
                    setTimeout(() => {
                        const todayEl = document.getElementById('today-col');
                        if (scrollRef.current && todayEl) {
                            scrollRef.current.scrollTo({ left: todayEl.offsetLeft - 120, behavior: 'smooth' });
                        }
                    }, 500);
                }, [monthName]);
                return <div id="table-scroll" ref={scrollRef} className="overflow-auto custom-scrollbar bg-white rounded-xl shadow border border-gray-200 relative"><ScheduleTableContent dateHeaders={dateHeaders} monthName={monthName} /></div>;
            };

            const ScheduleTableContent = ({ dateHeaders, monthName }) => {
                const dayStatuses = getDayStatusArray(dateHeaders);
                const today = new Date();
                today.setHours(0,0,0,0);
                const isTodayFunc = (d, s) => {
                    const monthNames = ['JANEIRO','FEVEREIRO','MARÇO','ABRIL','MAIO','JUNHO','JULHO','AGOSTO','SETEMBRO','OUTUBRO','NOVEMBRO','DEZEMBRO'];
                    return s === 'current' && parseInt(d) === today.getDate() && today.getMonth() === monthNames.indexOf(monthName.toUpperCase());
                }

                return (
                    <table className="w-full border-collapse">
                        <thead>
                            <tr className="bg-gray-100 border-b">
                                <th className="p-3 text-left text-xs font-bold text-gray-500 uppercase sticky-col min-w-[120px]">Operador</th>
                                {dateHeaders.map((day, idx) => {
                                    const isToday = isTodayFunc(day, dayStatuses[idx]);
                                    return <th key={idx} id={isToday ? "today-col" : ""} className={`p-2 text-center min-w-[3rem] ${isToday ? 'bg-blue-50' : ''}`}><div className={`text-xs font-bold ${dayStatuses[idx] === 'current' ? (isToday ? 'text-blue-600' : 'text-gray-600') : 'text-gray-300'}`}>{day}</div></th>;
                                })}
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {schedule.scheduleData.map((op, opIndex) => (
                                <tr key={opIndex} className="hover:bg-gray-50">
                                    <td className="p-3 text-sm font-semibold text-gray-700 sticky-col bg-white whitespace-nowrap truncate max-w-[120px]">{op.name}</td>
                                    {op.shifts.map((shift, dayIndex) => {
                                        const status = dayStatuses[dayIndex];
                                        const isCurrent = status === 'current';
                                        const config = SHIFT_CONFIG[shift] || SHIFT_CONFIG['---'];
                                        const pending = pendingSwaps.find(s => (s.initiator.opIndex == opIndex && s.initiator.dayIndex == dayIndex) || (s.recipient.opIndex == opIndex && s.recipient.dayIndex == dayIndex));
                                        
                                        let cellClass = "h-10 w-10 flex items-center justify-center font-bold text-sm rounded transition-all ";
                                        if (isCurrent) {
                                            cellClass += `${config.color} ${config.text} `;
                                            if (pending) cellClass += "ring-2 ring-green-500 animate-pulse ";
                                            if (isTodayFunc(dateHeaders[dayIndex], status)) cellClass += "ring-2 ring-blue-500 ";
                                        } else {
                                            cellClass += "grayscale-cell ";
                                        }

                                        return (
                                            <td key={dayIndex} className="p-0 text-center">
                                                <div className="p-1 min-w-[3rem]" onClick={() => handleCellClick(opIndex, dayIndex, op.name, shift, isCurrent)}>
                                                    <div className={cellClass}>{shift}</div>
                                                </div>
                                            </td>
                                        );
                                    })}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                );
            };

            // Renders
            if (loading) return <div className="min-h-screen flex items-center justify-center"><i className="fas fa-spinner fa-spin text-4xl text-indigo-600"></i></div>;
            if (user && userData?.status !== 'approved') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-orange-50 p-6 text-center">
                    <i className="fas fa-clock text-5xl text-orange-400 mb-6"></i>
                    <h2 className="text-2xl font-bold">Aguardando Aprovação</h2>
                    <Button onClick={logout} variant="secondary" className="mt-4">Sair</Button>
                </div>
            );

            return (
                <div className="min-h-screen pb-24">
                    <header className="bg-white shadow-sm px-4 py-3 flex justify-between items-center sticky top-0 z-40">
                        <div className="flex items-center gap-2">
                            <div className="bg-indigo-600 text-white p-2 rounded-lg"><i className="fas fa-layer-group"></i></div>
                            <div><h1 className="font-bold text-gray-800">Escala DNIZ</h1><p className="text-xs text-gray-500">{schedule ? `${schedule.monthName} ${schedule.year}` : (user ? 'Sem escala' : 'Visitante')}</p></div>
                        </div>
                        <div className="flex gap-2">
                            {!user ? <button onClick={login} className="bg-indigo-600 text-white px-3 py-1.5 rounded text-sm font-bold shadow">Entrar</button> : <button onClick={logout} className="w-10 h-10 bg-red-50 rounded-full text-red-500"><i className="fas fa-sign-out-alt"></i></button>}
                        </div>
                    </header>

                    <main className="p-4 fade-in">
                        {activeTab === 'home' && (
                            <>
                                <div className="mb-4"><Select options={schedulesList.length ? schedulesList.map(id => ({ value: id, label: id })) : [{value:'',label:'Nenhuma escala'}]} value={currentScheduleId||''} onChange={(e)=>setCurrentScheduleId(e.target.value)} /></div>
                                
                                {schedule ? (
                                    <>
                                        <div className="flex gap-2 mb-4">
                                            <Button className={`flex-1 text-xs ${!user?'opacity-50':''}`} variant={swapMode?'danger':'primary'} onClick={() => { if(user) setSwapMode(!swapMode); }}>{swapMode ? 'Cancelar Troca' : 'Trocar Turnos'}</Button>
                                            {userData?.isAdmin && (
                                                <Button className="flex-1 text-xs" variant="success" onClick={() => generatePDF(schedule)}>
                                                    <i className="fas fa-file-pdf"></i> PDF
                                                </Button>
                                            )}
                                        </div>
                                        {pendingSwaps.length > 0 && user && (
                                            <div className="mb-4 space-y-2">
                                                {pendingSwaps.map(req => {
                                                    const isMe = userData?.displayName?.toLowerCase().includes(req.recipient.opName.toLowerCase());
                                                    if (!isMe && !userData?.isAdmin) return null;
                                                    return (
                                                        <div key={req.id} className="bg-white p-3 rounded shadow-sm border-l-4 border-blue-500 text-sm">
                                                            <p><strong>{req.initiator.opName}</strong> ({req.initiator.shift}) <i className="fas fa-arrow-right"></i> <strong>{req.recipient.opName}</strong> ({req.recipient.shift})</p>
                                                            {isMe && <div className="flex gap-2 mt-2"><button onClick={async()=>{ /* Aceitar Lógica */ }} className="text-green-700 font-bold">Aceitar</button></div>}
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        )}
                                        <ScrollToToday dateHeaders={schedule.dateHeaders} monthName={schedule.monthName} />
                                    </>
                                ) : <div className="text-center py-10 text-gray-500"><i className="fas fa-folder-open text-4xl mb-2"></i><p>Selecione uma escala.</p></div>}
                            </>
                        )}
                        
                        {activeTab === 'admin' && userData?.isAdmin && (
                            <div className="space-y-6">
                                <div className="bg-white p-5 rounded shadow-sm">
                                    <h3 className="font-bold mb-3"><i className="fas fa-cog text-indigo-600"></i> Admin</h3>
                                    <label className="block w-full h-32 border-2 border-dashed rounded flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50">
                                        <i className="fas fa-cloud-upload-alt text-2xl text-gray-400"></i>
                                        <span className="text-sm text-gray-500">Carregar CSV</span>
                                        <input type="file" className="hidden" onChange={handleFileUpload} />
                                    </label>
                                    <div className="mt-4">
                                        <h4 className="font-bold text-sm mb-2">Aprovações Pendentes</h4>
                                        {pendingUsers.map(u => (
                                            <div key={u.uid} className="flex justify-between items-center bg-gray-50 p-2 rounded mb-2">
                                                <span className="text-sm">{u.displayName}</span>
                                                <div className="flex gap-1">
                                                    <button onClick={async()=>{ await updateDoc(doc(db, `artifacts/${firebaseConfig.projectId}/users`, u.uid), { status: 'approved' }); loadPendingUsers(); }} className="text-green-600 font-bold px-2">V</button>
                                                    <button onClick={async()=>{ await deleteDoc(doc(db, `artifacts/${firebaseConfig.projectId}/users`, u.uid)); loadPendingUsers(); }} className="text-red-600 font-bold px-2">X</button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around pb-[env(safe-area-inset-bottom)]">
                        <button onClick={()=>setActiveTab('home')} className={`p-4 ${activeTab==='home'?'text-indigo-600':'text-gray-400'}`}><i className="fas fa-calendar-day"></i></button>
                        {userData?.isAdmin && <button onClick={()=>setActiveTab('admin')} className={`p-4 ${activeTab==='admin'?'text-indigo-600':'text-gray-400'}`}><i className="fas fa-users-cog"></i></button>}
                    </nav>

                    {toast && <div className={`fixed bottom-24 left-4 right-4 p-4 rounded shadow-lg text-white text-center font-bold text-sm ${toast.type==='error'?'bg-red-500':'bg-green-600'}`}>{toast.msg}</div>}
                    
                    {isEditModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white p-6 rounded-lg w-full max-w-sm">
                                <h3 className="font-bold mb-4">Editar</h3>
                                <Select value={selectedCell.shift} onChange={(e)=>setSelectedCell({...selectedCell, shift:e.target.value})} options={Object.keys(SHIFT_CONFIG).map(k=>({value:k, label:k}))} />
                                <div className="flex gap-2 mt-4">
                                    <Button variant="secondary" onClick={()=>setEditModalOpen(false)} className="flex-1">Cancelar</Button>
                                    <Button onClick={async()=>{
                                        const newData = [...schedule.scheduleData]; newData[selectedCell.opIndex].shifts[selectedCell.dayIndex] = selectedCell.shift;
                                        await updateDoc(doc(db, `artifacts/${firebaseConfig.projectId}/schedules`, currentScheduleId), { scheduleData: newData });
                                        setSchedule({...schedule, scheduleData: newData}); setEditModalOpen(false);
                                    }} className="flex-1">Salvar</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
